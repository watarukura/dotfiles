export EDITOR=nvim
export PATH=$HOME/.nix-profile/bin:/opt/homebrew/bin:$HOME/.local/bin:$HOME/.local/share/aquaproj-aqua/bin:$PATH

# Nix
if [ -e '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh' ]; then
  . '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh'
fi
# End Nix

# starship
eval "$(starship init zsh)"

# less
export LESS='--no-init --IGNORE-CASE --RAW-CONTROL-CHARS --LONG-PROMPT'

# alias
alias la='ls -la'
alias ll='ls -l'
alias rm='rm -i'
alias mv='mv -i'
alias view='vim -R'
alias ls='gls --color=auto'
alias sed='gsed'
alias awk='gawk'
alias split='gsplit'
alias find='gfind'
alias xargs='gxargs'
alias zcat='gzcat'
alias date='gdate'
alias grep='ggrep'
alias du='gdu'
alias ping='ping -c 5'
alias pip='pip3'
alias python='python3'

# golang
export GOPATH=~/
export GO11MODULE=on
export GOROOT=$(go env GOROOT)
export PATH="$PATH:$GOROOT/bin"

# terraform
export TF_PLUGIN_CACHE_DIR="$HOME/.terraform.d/plugin-cache"

# direnv
direnv hook zsh | source

# zsh-autosuggestions
source $(brew --prefix)/share/zsh-autosuggestions/zsh-autosuggestions.zsh

# zsh-syntax-highlighting
source $(brew --prefix)/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh

# functions
function random_string() {
  if [ $# -eq 0 ]; then
    cat /dev/urandom | base64 | fold -w 12 | head -n 1
  else
    cat /dev/urandom | base64 | fold -w $1 | head -n 1
  fi
}

function cdr() {
  declare -r git_dir=$(git rev-parse --git-dir)
  cd "$git_dir/.."
}

function awsp() {
  aws configure list-profiles |
    fzf
}

function clear_storage() {
  aqua vacuum -d 1
  uv cache clean --force
  docker system prune --volumes
  brew cleanup
  go clean -modcache
  nix-collect-garbage
  npm cache clean --force
}

function memo() {
  declare -r memo_dir="$HOME/Documents/kurashidian/memo"
  declare -r template="$memo_dir/template.md"
  declare -r today=$(date +%Y-%m-%d)
  declare -r today_file="$memo_dir/$today.md"

  if [[ $# -ge 1 ]]; then
    if [[ "$1" == "list" ]]; then
      ls $memo_dir | fzf | xargs -o -I{} $EDITOR $memo_dir/{}
      return
    fi
    if [[ "$1" == "cd" ]]; then
      cd $memo_dir
      return
    fi
  fi

  # 前回日付を取得
  cd $memo_dir
  prev=$(basename \
    $(ls | grep -oP "[0-9]{4}-[0-9]{2}-[0-9]{2}.md" | sort | grep -v "$today" | tail -1) \
    .md)
  cd -

  # 今日のメモがなければ作成
  if [[ -e $today_file ]]; then
    echo "Opening today's memo: $today_file"
  elif [[ -e $template ]]; then
    echo "Creating new memo from template: $today_file"
    # <[[]] を <[[前日]] に書き換えて新規作成
    sed "s/<\[\[\]\]/<\[\[$prev\]\]/" $template >$today_file
  else
    echo "Template not found: $template"
    return 1
  fi

  # 前回のメモに当日のメモへのリンク
  if [[ -e "$prev".md ]]; then
    gsed -i "s;\[\[\]\]>;\[\[$today\]\]>;" "$prev".md
  fi

  $EDITOR $today_file
}
